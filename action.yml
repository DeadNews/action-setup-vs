name: Install Vapoursynth
description: Install Vapoursynth in the current runner

inputs:
  python-version:
    description: Python version to use
    required: true
  vs-version:
    description: Vapoursynth version to use, defaults to latest
    required: true
    default: R62 # renovate: datasource=pypi dep_name=vapoursynth

runs:
  using: composite
  steps:
    - name: Setup python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install vapoursynth make-deps
      if: runner.os == 'linux'
      shell: bash
      run: sudo apt install cython3 g++-12 libzimg-dev

    - name: Install vapoursynth make-deps
      if: runner.os == 'macos'
      shell: bash
      run: |
        brew install automake gcc zimg
        pip3 install cython

    - name: Use ccache
      if: runner.os == 'linux' || runner.os == 'macos'
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ runner.os }}-${{ inputs.python-version }}-${{ inputs.vs-version }}

    - name: Install vapoursynth
      if: runner.os == 'linux'
      shell: bash
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        git clone https://github.com/vapoursynth/vapoursynth --depth 1
        pushd vapoursynth
        ./autogen.sh
        ./configure --prefix=/usr --disable-x86-asm --disable-vspipe
        make -j2
        sudo make install -j2
        popd

    - name: Install vapoursynth
      if: runner.os == 'macos'
      shell: bash
      run: |
        export PATH="/usr/local/opt/ccache/libexec:$PATH"
        git clone https://github.com/vapoursynth/vapoursynth --depth 1 -b ${{ inputs.vs-version }}
        pushd vapoursynth
        ./autogen.sh
        ./configure --disable-x86-asm --disable-vspipe
        make -j3
        make install -j3
        popd
